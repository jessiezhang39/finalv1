<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
<script>

  
/* global nn */
let music, stopTimer;

// pick a letterâ€™s audio offset/duration
const samples = {
  a: { offset: 0.00,  duration: 1.87 },
  s: { offset: 1.89,  duration: 1.72 },
  d: { offset: 3.74,  duration: 1.92 },
  f: { offset: 7.06,  duration: 1.71 },
  h: { offset: 8.79,  duration: 1.69 },
  j: { offset: 10.52, duration: 1.70 },
};

// which letters spawn squares (all keys) and freeze on space
const SPAWN_KEYS = new Set(['a','s','d','f','h','j','k','l']);
const COLORS     = ['red','blue','white'];
const movingSquares = [];

// random HSL helper
function getRandomColor() {
  return `hsl(${Math.floor(Math.random()*360)},80%,60%)`;
}

// spawn one Mondrian square sliding across the screen
function spawnSquare() {
  const size     = 20 + Math.random()*80;
  const color    = COLORS[Math.floor(Math.random()*3)];
  const duration = 2 + Math.random()*3;  // sec
  let startX, startY, dx, dy;

  switch (Math.floor(Math.random()*4)) {
    case 0: // top
      startX = Math.random()*nn.width; startY = -size;
      dx = 0; dy = nn.height + size*2; break;
    case 1: // right
      startX = nn.width + size; startY = Math.random()*nn.height;
      dx = -nn.width - size*2; dy = 0;  break;
    case 2: // bottom
      startX = Math.random()*nn.width; startY = nn.height + size;
      dx = 0; dy = -nn.height - size*2; break;
    default: // left
      startX = -size; startY = Math.random()*nn.height;
      dx = nn.width + size*2; dy = 0;
  }

  const sq = nn.create('div')
    .css({
      position:        'absolute',
      width:           size  + 'px',
      height:          size  + 'px',
      left:            startX+ 'px',
      top:             startY+ 'px',
      backgroundColor: color,
      transition:      `transform ${duration}s linear`,
      transform:       'translate(0,0)',
    })
    .addTo('body');

  // kick off the slide
  setTimeout(() => {
    sq.css({ transform: `translate(${dx}px,${dy}px)` });
  }, 20);

  // remove when done
  const removal = setTimeout(() => sq.remove(), duration*1000 + 100);
  movingSquares.push({ el: sq, timer: removal });
}

// freeze in place
function freezeSquares() {
  movingSquares.forEach(({ el, timer }) => {
    clearTimeout(timer);
    const tf = window.getComputedStyle(el).transform;
    el.css({ transition: 'none', transform: tf });
  });
  movingSquares.length = 0;
}

// handle keypress: audio+spawn for A/S/D/F/H/J, spawn only for K/L, freeze on Space
function playSample(e) {
  const k = e.key.toLowerCase();
  if (samples[k]) {
    // play that sample
    const s = samples[k];
    music.currentTime = s.offset;
    music.play();
    if (stopTimer) clearTimeout(stopTimer);
    stopTimer = setTimeout(() => music.pause(), s.duration*1000);

    spawnSquare();
  }
  else if (SPAWN_KEYS.has(k)) {
    spawnSquare();
  }
  else if (k === ' ') {
    freezeSquares();
  }
}

// once audio is ready, show instructions
function fileLoaded() {
  nn.create('span')
    .content('Press A/S/D/F/H/J for audio+square; K/L for squares; Space to freeze')
    .css({
      position:     'absolute',
      top:          '10px',
      left:         '10px',
      padding:      '1rem 2rem',
      fontFamily:   'Garamond, serif',
      fontSize:     '1.2rem',
      color:        '#fff',
      background:   'rgba(0,0,0,0.3)',
      borderRadius: '12px',
      boxShadow:    '0 4px 20px rgba(0,0,0,0.3)',
    })
    .addTo('body');
}

// initial setup
function setup() {
  nn.get('body').css({
    userSelect:    'none',
    margin:        0,
    overflow:      'hidden',
    height:        '100vh',
    background:    getRandomColor(),
    display:       'flex',
    justifyContent:'center',
    alignItems:    'center',
    position:      'relative',
  });

  music = nn.create('audio')
    .set('src', 'violin-chords-easy-dreams_140bpm_C_minor.mp3')
    .addTo('body')
    .on('loadeddata', fileLoaded);
}

nn.on('load', setup);
nn.on('keypress', playSample);


</script>
