<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
<script>

  
/* global nn */
let music, stopTimer;

// pick a letterâ€™s audio offset/duration
const samples = {
  a: { offset: 0.00,  duration: 1.87 },
  s: { offset: 1.89,  duration: 1.72 },
  d: { offset: 3.74,  duration: 1.92 },
  f: { offset: 7.06,  duration: 1.71 },
  h: { offset: 8.79,  duration: 1.69 },
  j: { offset: 10.52, duration: 1.70 },
};

// which letters spawn squares (all keys) and freeze on space

const COLORS     = ['red','blue','white', 'yellow'];
const movingSquares = [];

let isDrawingLine = false;
let startX = 0, startY = 0;
let lineDiv = null;
  
const min = 10;
const max = 20;
const randomHeight = Math.random() * (max - min) + min;

function mouseDown(e) {
  isDrawingLine = true;
  startX = e.clientX;
  startY = e.clientY;
  lineDiv = nn.create('div')
    .css({
      position:        'absolute',
      backgroundColor: 'yellow',
      zIndex:          0
    })
    .addTo('body');
}

function mouseMove(e) {
  if (!isDrawingLine) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;

  if (Math.abs(dx) > Math.abs(dy)) {
    // Horizontal line
    const width = Math.abs(dx);
    const left  = dx > 0 ? startX : e.clientX;
    const top   = startY - 5;  // line thickness 10px
    lineDiv.css({
      left:   `${left}px`,
      top:    `${top}px`,
      width:  `${width}px`,
      height: `${randomHeight}px`
    });
  } else {
    // Vertical line
    const height = Math.abs(dy);
    const top    = dy > 0 ? startY : e.clientY;
    const left   = startX - 5;
    lineDiv.css({
      left:   `${left}px`,
      top:    `${top}px`,
      width:  `${randomHeight}px`,
      height: `${height}px`
    });
  }
}

function mouseUp(e) {
  if (!isDrawingLine) return;
  mouseMove(e);
  isDrawingLine = false;
  lineDiv = null;
}


// spawn one Mondrian square sliding across the screen
function spawnSquare() {
  const size     = 20 + Math.random()*80;
  const color    = COLORS[Math.floor(Math.random()*4)];
  const duration = 2 + Math.random()*3;  // sec
  let startX, startY, dx, dy;

  switch (Math.floor(Math.random()*4)) {
    case 0: // top
      startX = Math.random()*nn.width; startY = -size;
      dx = 0; dy = nn.height + size*2; break;
    case 1: // right
      startX = nn.width + size; startY = Math.random()*nn.height;
      dx = -nn.width - size*2; dy = 0;  break;
    case 2: // bottom
      startX = Math.random()*nn.width; startY = nn.height + size;
      dx = 0; dy = -nn.height - size*2; break;
    default: // left
      startX = -size; startY = Math.random()*nn.height;
      dx = nn.width + size*2; dy = 0;
  }

  const sq = nn.create('div')
    .css({
      position:        'absolute',
      width:           size  + 'px',
      height:          size  + 'px',
      left:            startX+ 'px',
      top:             startY+ 'px',
      backgroundColor: color,
      transition:      `transform ${duration}s linear`,
      transform:       'translate(0,0)',
    })
    .addTo('body');

  // kick off the slide
  setTimeout(() => {
    sq.css({ transform: `translate(${dx}px,${dy}px)` });
  }, 20);

  // remove when done
  const removal = setTimeout(() => sq.remove(), duration*1000 + 100);
  movingSquares.push({ el: sq, timer: removal });
}

// freeze in place
function freezeSquares() {
  movingSquares.forEach(({ el, timer }) => {
    clearTimeout(timer);
    const tf = window.getComputedStyle(el).transform;
    el.css({ transition: 'none', transform: tf });
  });
  movingSquares.length = 0;
}

// handle keypress: audio+spawn for A/S/D/F/H/J, spawn only for K/L, freeze on Space
function playSample(e) {
  const k = e.key.toLowerCase();
  if (samples[k]) {
    // play that sample
    const s = samples[k];
    music.currentTime = s.offset;
    music.play();
    if (stopTimer) clearTimeout(stopTimer);
    stopTimer = setTimeout(() => music.pause(), s.duration*1000);

    spawnSquare();
  }
  else if (k === ' ') {
    freezeSquares();
  }
}

// once audio is ready, show instructions
function fileLoaded() {
  const instruction = nn.create('span')
    .content(`
    Modrian reimagined! Start the flow of traffic with keys A - J, press space bar to freeze.
    `)
    .css({
      position:     'absolute',
      top:          'center',
      left:         'center',
      padding:      '1rem 2rem',
      fontFamily:   'Garamond, serif',
      fontSize:     '1.2rem',
      color:        '#fff',
      background:   'rgba(0,0,0,0.3)',
      borderRadius: '12px',
      boxShadow:    '0 4px 20px rgba(0,0,0,0.3)',
    })
   .addTo('body')
    setTimeout(() => {
    instruction.css({ transition: 'opacity 1s ease', opacity: 0 });
  }, 3000);
  
  nn.create('button')
  .content('Clear Grid')
  .css({
    position:   'absolute',
    top:        '10px',
    right:      '10px',
    padding:    '0.5rem 1rem',
    fontSize:   '0.9rem',
    zIndex:     999
  })
  .on('click', () => document.querySelectorAll('div').forEach(d => {
    if (d.style.backgroundColor === 'yellow') d.remove();
  }))
    .addTo('body');
}

// initial setup
function setup() {
  nn.get('body').css({
    userSelect:    'none',
    margin:        0,
    overflow:      'hidden',
    height:        '100vh',
    background:    'white',
    display:       'flex',
    justifyContent:'center',
    alignItems:    'center',
    position:      'relative',
  });

  music = nn.create('audio')
    .set('src', 'violin-chords-easy-dreams_140bpm_C_minor.mp3')
    .addTo('body')
    .on('loadeddata', fileLoaded);
}

nn.on('load', setup)
nn.on('keypress', playSample)
nn.on('mousedown', mouseDown)
nn.on('mousemove', mouseMove)
nn.on('mouseup', mouseUp)

</script>
